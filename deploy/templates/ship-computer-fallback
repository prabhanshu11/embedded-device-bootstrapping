#!/bin/bash
# Ship Computer Fallback â€” RPi5 lightweight desktop monitor
#
# Runs every 2 minutes via systemd timer. Pings desktop over Tailscale.
# If desktop is unreachable, notifies user on Telegram.
# Does NOT process messages or run Claude â€” desktop handles everything.
#
# Config: /etc/ship-computer-fallback.conf
#   BOT_TOKEN=...
#   CHAT_ID=...
#   DESKTOP_IP=100.92.71.80

set -e

CONFIG="/etc/ship-computer-fallback.conf"
STATE_FILE="/tmp/ship-computer-fallback-state"

if [[ ! -f "$CONFIG" ]]; then
    echo "ERROR: Config not found: $CONFIG" >&2
    exit 1
fi

source "$CONFIG"

: "${BOT_TOKEN:?BOT_TOKEN not set in $CONFIG}"
: "${CHAT_ID:?CHAT_ID not set in $CONFIG}"
: "${DESKTOP_IP:=100.92.71.80}"

# Check desktop reachability via Tailscale
desktop_online() {
    tailscale ping --timeout=5s "$DESKTOP_IP" &>/dev/null
}

# Send a Telegram message
tg_send() {
    local text="$1"
    curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d text="$text" \
        -d parse_mode="Markdown" \
        >/dev/null 2>&1
}

# Read previous state (online/offline)
prev_state="online"
[[ -f "$STATE_FILE" ]] && prev_state=$(cat "$STATE_FILE")

if desktop_online; then
    if [[ "$prev_state" == "offline" ]]; then
        tg_send "ðŸŸ¢ *Ship Computer* â€” Desktop is back online. Resuming normal operations."
    fi
    echo "online" > "$STATE_FILE"
else
    if [[ "$prev_state" == "online" ]]; then
        tg_send "ðŸ”´ *Ship Computer* â€” Desktop is offline. Messages will queue until it returns (up to 24h)."
    fi
    echo "offline" > "$STATE_FILE"
fi
